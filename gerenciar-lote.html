<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Lotes</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0A0F1A" />
  <link rel="icon" type="image/png" href="./img/logo-48.png" />
  <link rel="apple-touch-icon" href="./img/logo-192.png" />

  <!-- Estilos -->
  <link rel="stylesheet" href="style.css" />

  <!-- jsPDF -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <!-- Splash -->
  <div id="splash">
    <img src="./img/logo-192.png" alt="Logo" id="splash-logo" />
    <h2 id="splash-text">Carregando...</h2>
  </div>

  <!-- CabeÃ§alho -->
  <header>
    <img src="./img/logo-48.png" alt="Logo" class="logo" />
    <h1>Gerenciar Lotes</h1>
    <button id="themeToggle">â˜€ï¸ Modo Claro</button>
  </header>

  <main>
    <!-- Card do evento -->
    <section class="card">
      <h2 id="tituloEvento">Evento</h2>
      <p id="dataEvento"></p>
      <hr />

      <h3>Lotes Cadastrados</h3>
      <div id="listaLotes"></div>

      <button id="btnNovoLote">â• Novo Lote</button>
      <button id="voltar">â¬…ï¸ Voltar</button>
    </section>

    <!-- Card dos setores -->
    <section class="card" id="secaoSetores" style="display:none;">
      <h3 id="tituloLote">Editar Lote</h3>
      <div id="listaSetores"></div>

      <div style="margin-top: 10px;">
        <button id="btnAddSetor">â• Adicionar Setor</button>
        <button id="btnSalvarLote" class="btn-salvar">ğŸ’¾ Salvar Lote</button>
        <button id="btnPDFLote" class="btn-pdf-ultimo">ğŸ“„ Gerar PDF (Lote Atual)</button>
        <button id="btnFecharLote" class="btn-cancelar">âŒ Fechar</button>
      </div>
    </section>
  </main>

  <footer>
    <p>Gerenciamento de Lotes | Desenvolvido por Eric Filipe</p>
  </footer>

  <script>
    // === Tema ===
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("themeToggle");
      const b = document.body;
      const saved = localStorage.getItem("theme");

      if (saved === "light") {
        b.classList.add("light-mode");
        btn.textContent = "ğŸŒ™ Modo Escuro";
      }

      btn.onclick = () => {
        b.classList.toggle("light-mode");
        const light = b.classList.contains("light-mode");
        btn.textContent = light ? "ğŸŒ™ Modo Escuro" : "â˜€ï¸ Modo Claro";
        localStorage.setItem("theme", light ? "light" : "dark");
      };
    });

    // === Splash ===
    window.addEventListener("load", () => {
      const splash = document.getElementById("splash");
      setTimeout(() => {
        splash.style.opacity = "0";
        splash.style.visibility = "hidden";
      }, 1200);
    });

    // === Dados ===
    const eventos = JSON.parse(localStorage.getItem("eventos")) || [];
    const idSelecionado = Number(localStorage.getItem("eventoSelecionado"));
    const evento = eventos.find(e => e.id === idSelecionado);

    if (!evento) {
      alert("âš ï¸ Evento nÃ£o encontrado.");
      window.location.href = "index.html";
    }

    const listaLotes = document.getElementById("listaLotes");
    const secaoSetores = document.getElementById("secaoSetores");
    const listaSetores = document.getElementById("listaSetores");

    document.getElementById("tituloEvento").textContent = evento?.nome || "Evento nÃ£o encontrado";
    document.getElementById("dataEvento").textContent =
      "Data: " + (evento?.data ? new Date(evento.data).toLocaleDateString("pt-BR") : "Indefinida");

    function salvar() {
      const todos = JSON.parse(localStorage.getItem("eventos")) || [];
      const idx = todos.findIndex(e => e.id === evento.id);
      if (idx >= 0) todos[idx] = evento;
      localStorage.setItem("eventos", JSON.stringify(todos));
    }

    function renderLotes() {
      listaLotes.innerHTML = "";
      if (!evento.lotes || evento.lotes.length === 0) {
        listaLotes.innerHTML = "<p>Nenhum lote cadastrado.</p>";
        return;
      }

      evento.lotes.forEach((l, i) => {
        const div = document.createElement("div");
        div.classList.add("lote-card");
        div.innerHTML = `
          <h4>${l.nome}</h4>
          <p>${l.setores?.length || 0} setor(es)</p>
          <button onclick="abrirLote(${i})">âœï¸ Editar</button>
          <button onclick="excluirLote(${i})" class="btn-cancelar">ğŸ—‘ Excluir</button>
        `;
        listaLotes.appendChild(div);
      });
    }

    window.abrirLote = function (i) {
      secaoSetores.style.display = "block";
      listaSetores.innerHTML = "";
      const lote = evento.lotes[i];
      listaSetores.dataset.index = i;
      document.getElementById("tituloLote").textContent = "Editando: " + lote.nome;

      (lote.setores || []).forEach((s, idx) => {
        const div = document.createElement("div");
        div.classList.add("setor");
        div.innerHTML = `
          <input type="text" value="${s.setor}" placeholder="Setor">
          <input type="number" value="${s.valores.meia}" placeholder="Meia">
          <input type="number" value="${s.valores.solidario}" placeholder="SolidÃ¡rio">
          <input type="number" value="${s.valores.inteira}" placeholder="Inteira">
          <button onclick="removerSetor(${idx})" class="btn-cancelar">ğŸ—‘</button>
        `;
        listaSetores.appendChild(div);
      });
    };

    window.excluirLote = function (i) {
      if (!confirm("Excluir este lote?")) return;
      evento.lotes.splice(i, 1);
      salvar();
      renderLotes();
    };

    function adicionarSetor() {
      const i = Number(listaSetores.dataset.index);
      if (i >= 0) {
        evento.lotes[i].setores = evento.lotes[i].setores || [];
        evento.lotes[i].setores.push({
          setor: "Novo Setor",
          valores: { meia: 0, solidario: 0, inteira: 0 }
        });
        salvar();
        abrirLote(i);
      }
    }

    window.removerSetor = function (idx) {
      const i = Number(listaSetores.dataset.index);
      evento.lotes[i].setores.splice(idx, 1);
      salvar();
      abrirLote(i);
    };

    function salvarLote() {
      const i = Number(listaSetores.dataset.index);
      const setores = [];
      listaSetores.querySelectorAll(".setor").forEach(div => {
        const [setor, meia, solid, inte] = div.querySelectorAll("input");
        setores.push({
          setor: setor.value.trim() || "Setor",
          valores: {
            meia: Number(meia.value) || 0,
            solidario: Number(solid.value) || 0,
            inteira: Number(inte.value) || 0
          }
        });
      });
      evento.lotes[i].setores = setores;
      salvar();
      alert("âœ… Lote salvo!");
      secaoSetores.style.display = "none";
      renderLotes();
    }

    async function gerarPDFLoteAtual() {
      if (!window.jspdf) {
        alert("âš ï¸ Gerador de PDF ainda carregando. Tente novamente.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const i = Number(listaSetores.dataset.index);
      if (isNaN(i)) return alert("Nenhum lote aberto.");

      const lote = evento.lotes[i];
      const doc = new jsPDF();
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text(evento.nome, 10, 20);
      doc.setFont("helvetica", "normal");
      doc.text(`Data do Evento: ${new Date(evento.data).toLocaleDateString("pt-BR")}`, 10, 30);
      doc.text(`Lote Atual: ${lote.nome}`, 10, 45);

      let y = 60;
      if (lote.setores?.length) {
        lote.setores.forEach((s, idx) => {
          doc.text(`${idx + 1}. ${s.setor}`, 10, y);
          doc.text(`Meia: R$ ${s.valores.meia}`, 70, y);
          doc.text(`SolidÃ¡rio: R$ ${s.valores.solidario}`, 110, y);
          doc.text(`Inteira: R$ ${s.valores.inteira}`, 160, y);
          y += 10;
          if (y > 270) {
            doc.addPage();
            y = 20;
          }
        });
      } else {
        doc.text("Nenhum setor cadastrado neste lote.", 10, y);
      }

      doc.save(`${evento.nome}-${lote.nome}.pdf`);
    }

    document.getElementById("btnNovoLote").onclick = () => {
      const nome = prompt("Nome do novo lote:");
      if (!nome) return;
      evento.lotes = evento.lotes || [];
      evento.lotes.push({ nome, setores: [] });
      salvar();
      renderLotes();
    };

    document.getElementById("btnAddSetor").onclick = adicionarSetor;
    document.getElementById("btnSalvarLote").onclick = salvarLote;
    document.getElementById("btnPDFLote").onclick = gerarPDFLoteAtual;
    document.getElementById("btnFecharLote").onclick = () => (secaoSetores.style.display = "none");
    document.getElementById("voltar").onclick = () => (window.location.href = "index.html");

    renderLotes();
  </script>
</body>
</html>
