<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Lotes</title>
  <meta name="theme-color" content="#0A0F1A" />
  
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Ãcone -->
  <link rel="icon" type="image/png" sizes="192x192" href="img/logo-192.png" />

  <!-- jsPDF -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Script -->
  <script src="script.js" defer></script>
</head>

<body>
  <!-- Splash -->
  <div id="splash">
    <img src="img/logo-512.png" alt="Logo" id="splash-logo" />
    <h2 id="splash-text">Carregando...</h2>
  </div>

  <header>
    <img src="img/logo.png" alt="Logo" class="logo" />
    <h1>Gerenciar Lotes</h1>
    <button id="themeToggle">â˜€ï¸ Modo Claro</button>
  </header>

  <main>
    <section class="card">
      <h2 id="tituloEvento">Evento</h2>
      <p id="dataEvento"></p>
      <hr />
      <h3>Lotes Cadastrados</h3>
      <div id="listaLotes"></div>
      <button id="btnNovoLote">â• Novo Lote</button>
      <button id="voltar">â¬…ï¸ Voltar</button>
    </section>

    <section class="card" id="secaoSetores" style="display:none;">
      <h3 id="tituloLote">Editar Lote</h3>
      <div id="listaSetores"></div>
      <div style="margin-top:10px;">
        <button id="btnAddSetor">â• Adicionar Setor</button>
        <button id="btnSalvarLote">ğŸ’¾ Salvar Lote</button>
        <button id="btnPDFLote" class="btn-pdf-ultimo">ğŸ“„ Gerar PDF (Lote Atual)</button>
        <button id="btnFecharLote" class="btn-cancelar">âŒ Fechar</button>
      </div>
    </section>
  </main>

  <footer>
    <p>Gerenciamento de Lotes | Desenvolvido por Eric Filipe</p>
  </footer>

  <script>
    // SPLASH
    document.addEventListener("DOMContentLoaded", () => {
      const splash = document.getElementById("splash");
      setTimeout(() => {
        splash.style.opacity = "0";
        splash.style.visibility = "hidden";
      }, 1800);
    });

    // === Tema ===
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("themeToggle"), body = document.body;
      const saved = localStorage.getItem("theme");
      if (saved === "light") {
        body.classList.add("light-mode");
        btn.textContent = "ğŸŒ™ Modo Escuro";
      }
      btn.onclick = () => {
        body.classList.toggle("light-mode");
        const isLight = body.classList.contains("light-mode");
        btn.textContent = isLight ? "ğŸŒ™ Modo Escuro" : "â˜€ï¸ Modo Claro";
        localStorage.setItem("theme", isLight ? "light" : "dark");
      };
    });

    // === Dados do Evento ===
    const eventos = JSON.parse(localStorage.getItem("eventos") || "[]");
    const idSelecionado = Number(localStorage.getItem("eventoSelecionado")) || 0;
    const evento = eventos.find(e => e.id === idSelecionado);

    if (!evento) {
      alert("Evento nÃ£o encontrado.");
      window.location.href = "index.html";
    }

    document.getElementById("tituloEvento").textContent = evento?.nome || "Evento Desconhecido";
    document.getElementById("dataEvento").textContent = evento?.data
      ? "Data: " + new Date(evento.data).toLocaleDateString("pt-BR")
      : "Data nÃ£o informada.";

    const listaLotes = document.getElementById("listaLotes");
    const secaoSetores = document.getElementById("secaoSetores");
    const listaSetores = document.getElementById("listaSetores");

    // === Salvar no localStorage ===
    function salvar() {
      const todos = JSON.parse(localStorage.getItem("eventos") || "[]");
      const i = todos.findIndex(e => e.id === evento.id);
      if (i >= 0) todos[i] = evento;
      localStorage.setItem("eventos", JSON.stringify(todos));
    }

    // === RenderizaÃ§Ã£o ===
    function renderLotes() {
      listaLotes.innerHTML = "";
      if (!evento.lotes || !evento.lotes.length) {
        listaLotes.innerHTML = "<p>Nenhum lote cadastrado.</p>";
        return;
      }

      evento.lotes.forEach((l, i) => {
        const div = document.createElement("div");
        div.classList.add("lote-card");
        div.innerHTML = `
          <h4>${l.nome}</h4>
          <p>${l.setores?.length || 0} setor(es)</p>
          <button onclick="abrirLote(${i})">Editar</button>
          <button onclick="excluirLote(${i})" class="btn-cancelar">Excluir</button>
        `;
        listaLotes.appendChild(div);
      });
    }

    // === Abrir lote ===
    window.abrirLote = (i) => {
      secaoSetores.style.display = "block";
      listaSetores.innerHTML = "";
      const lote = evento.lotes[i];
      document.getElementById("tituloLote").textContent = "Editando: " + lote.nome;
      listaSetores.dataset.index = i;

      (lote.setores || []).forEach((s, idx) => {
        const div = document.createElement("div");
        div.classList.add("setor");
        div.innerHTML = `
          <input type="text" value="${s.setor}" placeholder="Setor" />
          <input type="number" value="${s.valores.meia}" placeholder="Meia" />
          <input type="number" value="${s.valores.solidario}" placeholder="SolidÃ¡rio" />
          <input type="number" value="${s.valores.inteira}" placeholder="Inteira" />
          <button onclick="removerSetor(${idx})" class="btn-cancelar">ğŸ—‘</button>
        `;
        listaSetores.appendChild(div);
      });
    };

    // === Excluir Lote ===
    window.excluirLote = (i) => {
      if (!confirm("Deseja realmente excluir este lote?")) return;
      evento.lotes.splice(i, 1);
      salvar();
      renderLotes();
    };

    // === Adicionar Setor ===
    function adicionarSetor() {
      const i = Number(listaSetores.dataset.index);
      if (i >= 0) {
        evento.lotes[i].setores = evento.lotes[i].setores || [];
        evento.lotes[i].setores.push({
          setor: "Novo Setor",
          valores: { meia: 0, solidario: 0, inteira: 0 }
        });
        salvar();
        abrirLote(i);
      }
    }

    // === Remover Setor ===
    window.removerSetor = (idx) => {
      const i = Number(listaSetores.dataset.index);
      evento.lotes[i].setores.splice(idx, 1);
      salvar();
      abrirLote(i);
    };

    // === Salvar Lote ===
    function salvarLote() {
      const i = Number(listaSetores.dataset.index);
      const inputs = listaSetores.querySelectorAll(".setor");
      const setores = [];
      inputs.forEach(div => {
        const [setor, meia, solid, inte] = div.querySelectorAll("input");
        setores.push({
          setor: setor.value.trim() || "Setor",
          valores: {
            meia: Number(meia.value) || 0,
            solidario: Number(solid.value) || 0,
            inteira: Number(inte.value) || 0
          }
        });
      });
      evento.lotes[i].setores = setores;
      salvar();
      alert("âœ… Lote salvo!");
      secaoSetores.style.display = "none";
      renderLotes();
    }

    // === PDF do Lote Atual ===
    async function gerarPDFLoteAtual() {
      if (!window.jspdf) return alert("O gerador de PDF ainda estÃ¡ carregando...");
      const { jsPDF } = window.jspdf;
      const i = Number(listaSetores.dataset.index);
      if (isNaN(i)) return alert("Nenhum lote aberto.");
      const lote = evento.lotes[i];
      const doc = new jsPDF();
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text(evento.nome, 10, 20);
      doc.setFontSize(12);
      doc.text(`Data do Evento: ${new Date(evento.data).toLocaleDateString("pt-BR")}`, 10, 30);
      doc.text(`Lote Atual: ${lote.nome}`, 10, 45);
      let y = 60;
      lote.setores.forEach((s, idx) => {
        doc.text(`${idx + 1}. ${s.setor}`, 10, y);
        doc.text(`Meia: R$ ${s.valores.meia}`, 70, y);
        doc.text(`SolidÃ¡rio: R$ ${s.valores.solidario}`, 110, y);
        doc.text(`Inteira: R$ ${s.valores.inteira}`, 160, y);
        y += 10;
        if (y > 270) { doc.addPage(); y = 20; }
      });
      doc.save(`${evento.nome}-${lote.nome}.pdf`);
    }

    // === BotÃµes ===
    document.getElementById("btnNovoLote").onclick = () => {
      const nome = prompt("Nome do novo lote:");
      if (!nome) return;
      evento.lotes = evento.lotes || [];
      evento.lotes.push({ nome, setores: [] });
      salvar();
      renderLotes();
    };

    document.getElementById("btnAddSetor").onclick = adicionarSetor;
    document.getElementById("btnSalvarLote").onclick = salvarLote;
    document.getElementById("btnPDFLote").onclick = gerarPDFLoteAtual;
    document.getElementById("btnFecharLote").onclick = () => secaoSetores.style.display = "none";
    document.getElementById("voltar").onclick = () => window.location.href = "index.html";

    renderLotes();
  </script>
</body>
</html>
