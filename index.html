<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Lotes</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0A0F1A" />
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash">
    <img src="img/logo.png" alt="Logo" id="splash-logo" />
    <h2 id="splash-text">Carregando...</h2>
  </div>

  <header>
    <img src="img/logo.png" alt="Logo" class="logo" />
    <h1>Gerenciar Lotes</h1>
    <button id="themeToggle">â˜€ï¸ Modo Claro</button>
  </header>

  <main>
    <section class="card">
      <h2 id="tituloEvento">Evento</h2>
      <p id="dataEvento"></p>
      <hr />
      <h3>Lotes Cadastrados</h3>
      <div id="listaLotes"></div>
      <button id="btnNovoLote">â• Novo Lote</button>
      <button id="voltar">â¬…ï¸ Voltar</button>
    </section>

    <section class="card" id="secaoSetores" style="display:none;">
      <h3 id="tituloLote">Editar Lote</h3>
      <div id="listaSetores"></div>
      <div style="margin-top:10px;">
        <button id="btnAddSetor">â• Adicionar Setor</button>
        <button id="btnSalvarLote">ğŸ’¾ Salvar Lote</button>
        <button id="btnPDFLote" class="btn-pdf-ultimo">ğŸ“„ Gerar PDF (Lote Atual)</button>
        <button id="btnFecharLote">âŒ Fechar</button>
      </div>
    </section>
  </main>

  <footer>
    <p>Gerenciamento de Lotes | Desenvolvido por Eric Filipe</p>
  </footer>

  <script>
    // === Sons ===
    const sounds = {
      click: new Audio("data:audio/mp3;base64,//uQxAAACAAf5f7p6VUEAAAB9AAABpAAABAAABHCAABGgAAACAAADSAAAAJAAAAEAAASAAABGgAAACAAADSAAAAJAAAAEAAASAAABGgAAACAAADSAAAAJAAAAEAAASAAABGgAAAA//uQZAAAAEoAAD6AAAAgAAAAgAAAAIAAAAD/7kGQAAABKAAA+gAAAIAAAACAAAAAgAAAAD//2wBDAAICAgICAgMCAgMEAwMDBAYEBAQEBAgGBgUGCQgKCgkICQsJDAwMDAwMEAwQDAwMEA8PDwwNDg4ODw4PDA0NDf/AABEIAKgBLAMBIgACEQEDEQH/xAAZAAEAAwEBAAAAAAAAAAAAAAAABAUGAwH/xAAhEAABAwMFAQEAAAAAAAAAAAAAAQIDBAUREiExUWEGQf/EABgBAAIDAAAAAAAAAAAAAAAAAAQBAgMF/8QAGREAAwEBAQAAAAAAAAAAAAAAAAECERJB/9oADAMBAAIRAxEAPwCVL7Mmy1oSRgAABBBxjjvtu/hVhbUeZ7ZmgFZB8dyjnvfIaSu+Vv1OzCh0//2Q==")
    };
    function playSound(name) {
      const s = sounds[name];
      if (s) { s.currentTime = 0; s.volume = 0.35; s.play().catch(()=>{}); }
    }

    // === Tema Claro/Escuro ===
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("themeToggle");
      const body = document.body;
      const saved = localStorage.getItem("theme");
      if (saved === "light") {
        body.classList.add("light-mode");
        btn.textContent = "ğŸŒ™ Modo Escuro";
      }
      btn.onclick = () => {
        body.classList.toggle("light-mode");
        const l = body.classList.contains("light-mode");
        btn.textContent = l ? "ğŸŒ™ Modo Escuro" : "â˜€ï¸ Modo Claro";
        localStorage.setItem("theme", l ? "light" : "dark");
        playSound("click");
      };
    });

    // === Splash ===
    document.addEventListener("DOMContentLoaded", () => {
      const splash = document.getElementById("splash");
      setTimeout(() => {
        splash.style.opacity = "0";
        splash.addEventListener("transitionend", () => splash.remove());
      }, 1500);
    });

    // === Carregar dados ===
    let eventos = [];
    try { eventos = JSON.parse(localStorage.getItem("eventos")) || []; }
    catch { eventos = []; }

    const idSelecionado = Number(localStorage.getItem("eventoSelecionado")) || 0;
    const evento = eventos.find(e => e.id === idSelecionado);

    if (!evento) {
      alert("âš ï¸ Evento nÃ£o encontrado ou nÃ£o selecionado!");
      window.location.href = "index.html";
    }

    const tituloEvento = document.getElementById("tituloEvento");
    const dataEvento = document.getElementById("dataEvento");
    const listaLotes = document.getElementById("listaLotes");
    const secaoSetores = document.getElementById("secaoSetores");
    const listaSetores = document.getElementById("listaSetores");

    tituloEvento.textContent = evento?.nome || "Evento nÃ£o encontrado";
    dataEvento.textContent = "Data: " + (evento?.data ? new Date(evento.data).toLocaleDateString("pt-BR") : "Indefinida");

    function salvar() {
      const todos = JSON.parse(localStorage.getItem("eventos")) || [];
      const idx = todos.findIndex(e => e.id === evento.id);
      if (idx >= 0) todos[idx] = evento;
      localStorage.setItem("eventos", JSON.stringify(todos));
    }

    // === Renderizar lotes (versÃ£o segura) ===
    function renderLotes() {
      if (!listaLotes) return console.warn("âš ï¸ listaLotes nÃ£o existe no DOM.");
      if (!evento || typeof evento !== "object") {
        listaLotes.innerHTML = "<p>âš ï¸ Evento nÃ£o encontrado.</p>";
        return;
      }

      listaLotes.innerHTML = "";
      if (!Array.isArray(evento.lotes) || evento.lotes.length === 0) {
        listaLotes.innerHTML = "<p>Nenhum lote cadastrado.</p>";
        return;
      }

      evento.lotes.forEach((l, i) => {
        const div = document.createElement("div");
        div.classList.add("lote-card");
        div.innerHTML = `
          <h4>${l.nome}</h4>
          <p>${l.setores?.length || 0} setor(es)</p>
          <button onclick="abrirLote(${i})">Editar</button>
          <button onclick="excluirLote(${i})" class="btn-cancelar">Excluir</button>
        `;
        listaLotes.appendChild(div);
      });
    }

    function abrirLote(i) {
      const lote = evento.lotes[i];
      if (!lote) return alert("Lote nÃ£o encontrado.");
      secaoSetores.style.display = "block";
      listaSetores.innerHTML = "";
      document.getElementById("tituloLote").textContent = "Editando: " + lote.nome;
      listaSetores.dataset.index = i;
      (lote.setores || []).forEach((s, idx) => {
        const div = document.createElement("div");
        div.classList.add("setor");
        div.innerHTML = `
          <input type="text" value="${s.setor}" placeholder="Setor">
          <input type="number" value="${s.valores.meia}" placeholder="Meia">
          <input type="number" value="${s.valores.solidario}" placeholder="SolidÃ¡rio">
          <input type="number" value="${s.valores.inteira}" placeholder="Inteira">
          <button onclick="removerSetor(${idx})" class="btn-cancelar">ğŸ—‘</button>
        `;
        listaSetores.appendChild(div);
      });
    }

    function excluirLote(i) {
      if (!confirm("Excluir este lote?")) return;
      evento.lotes.splice(i, 1);
      salvar();
      renderLotes();
    }

    function adicionarSetor() {
      const i = Number(listaSetores.dataset.index);
      if (i >= 0) {
        evento.lotes[i].setores = evento.lotes[i].setores || [];
        evento.lotes[i].setores.push({ setor: "Novo Setor", valores: { meia: 0, solidario: 0, inteira: 0 } });
        salvar();
        abrirLote(i);
      }
    }

    function removerSetor(idx) {
      const i = Number(listaSetores.dataset.index);
      evento.lotes[i].setores.splice(idx, 1);
      salvar();
      abrirLote(i);
    }

    function salvarLote() {
      const i = Number(listaSetores.dataset.index);
      const setores = [];
      listaSetores.querySelectorAll(".setor").forEach(div => {
        const [setor, meia, solid, inte] = div.querySelectorAll("input");
        setores.push({
          setor: setor.value.trim() || "Setor",
          valores: {
            meia: Number(meia.value) || 0,
            solidario: Number(solid.value) || 0,
            inteira: Number(inte.value) || 0
          }
        });
      });
      evento.lotes[i].setores = setores;
      salvar();
      alert("âœ… Lote salvo!");
      secaoSetores.style.display = "none";
      renderLotes();
    }

    async function gerarPDFLoteAtual() {
      if (!window.jspdf) return alert("âš ï¸ Gerador de PDF ainda carregando.");
      const { jsPDF } = window.jspdf;
      const i = Number(listaSetores.dataset.index);
      if (isNaN(i)) return alert("Nenhum lote aberto.");
      const lote = evento.lotes[i];
      const doc = new jsPDF();
      doc.setFont("helvetica","bold");
      doc.setFontSize(18);
      doc.text(evento.nome,10,20);
      doc.setFont("helvetica","normal");
      doc.setFontSize(12);
      doc.text(`Data do Evento: ${new Date(evento.data).toLocaleDateString("pt-BR")}`,10,30);
      doc.text(`Lote Atual: ${lote.nome}`,10,45);
      let y=60;
      if(lote.setores?.length){
        lote.setores.forEach((s,idx)=>{
          doc.text(`${idx+1}. ${s.setor}`,10,y);
          doc.text(`Meia: R$ ${s.valores.meia}`,70,y);
          doc.text(`SolidÃ¡rio: R$ ${s.valores.solidario}`,110,y);
          doc.text(`Inteira: R$ ${s.valores.inteira}`,160,y);
          y+=10;if(y>270){doc.addPage();y=20;}
        });
      }else doc.text("Nenhum setor cadastrado neste lote.",10,y);
      playSound("click");
      doc.save(`${evento.nome}-${lote.nome}.pdf`);
    }

    // === BotÃµes ===
    document.getElementById("btnNovoLote").onclick = () => {
      const nome = prompt("Nome do novo lote:");
      if (!nome) return;
      evento.lotes = evento.lotes || [];
      evento.lotes.push({ nome, setores: [] });
      salvar();
      renderLotes();
    };

    document.getElementById("btnAddSetor").onclick = adicionarSetor;
    document.getElementById("btnSalvarLote").onclick = salvarLote;
    document.getElementById("btnPDFLote").onclick = gerarPDFLoteAtual;
    document.getElementById("btnFecharLote").onclick = () => secaoSetores.style.display = "none";
    document.getElementById("voltar").onclick = () => {
      playSound("click");
      window.location.href = "index.html";
    };

    renderLotes();
  </script>
</body>
</html>
