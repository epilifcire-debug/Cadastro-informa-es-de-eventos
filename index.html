<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Lotes</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0A0F1A">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash">
    <img src="img/logo.png" alt="Logo" id="splash-logo">
    <h2 id="splash-text">Carregando...</h2>
  </div>

  <header>
    <img src="img/logo.png" alt="Logo" class="logo">
    <h1>Gerenciar Lotes</h1>
    <button id="themeToggle">‚òÄÔ∏è Modo Claro</button>
  </header>

  <main>
    <section class="card">
      <h2 id="tituloEvento">Evento</h2>
      <p id="dataEvento"></p>
      <hr>

      <h3>Lotes Cadastrados</h3>
      <div id="listaLotes"></div>

      <button id="btnNovoLote">‚ûï Novo Lote</button>
      <button id="voltar">‚¨ÖÔ∏è Voltar</button>
    </section>

    <section class="card" id="secaoSetores" style="display:none;">
      <h3 id="tituloLote">Editar Lote</h3>
      <div id="listaSetores"></div>
      <button id="btnAddSetor">‚ûï Adicionar Setor</button>
      <button id="btnSalvarLote">üíæ Salvar Lote</button>
      <button id="btnFecharLote">‚ùå Fechar</button>
    </section>
  </main>

  <footer>
    <p>Gerenciamento de Lotes | Desenvolvido por Eric Filipe</p>
  </footer>

  <!-- === Script === -->
  <script>
    // Fun√ß√µes de som (importadas do index principal)
    const sounds = {
      click: new Audio("data:audio/mp3;base64,//uQxAAACAAf5f7p6VUEAAAB9AAABpAAABAAABHCAABGgAAACAAADSAAAAJAAAAEAAASAAABGgAAACAAADSAAAAJAAAAEAAASAAABGgAAACAAADSAAAAJAAAAEAAASAAABGgAAAA//uQZAAAAEoAAD6AAAAgAAAAgAAAAIAAAAD/7kGQAAABKAAA+gAAAIAAAACAAAAAgAAAAD//2wBDAAICAgICAgMCAgMEAwMDBAYEBAQEBAgGBgUGCQgKCgkICQsJDAwMDAwMEAwQDAwMEA8PDwwNDg4ODw4PDA0NDf/AABEIAKgBLAMBIgACEQEDEQH/xAAZAAEAAwEBAAAAAAAAAAAAAAAABAUGAwH/xAAhEAABAwMFAQEAAAAAAAAAAAAAAQIDBAUREiExUWEGQf/EABgBAAIDAAAAAAAAAAAAAAAAAAQBAgMF/8QAGREAAwEBAQAAAAAAAAAAAAAAAAECERJB/9oADAMBAAIRAxEAPwCVL7Mmy1oSRgAABBBxjjvtu/hVhbUeZ7ZmgFZB8dyjnvfIaSu+Vv1OzCh0//2Q==")
    };
    function playSound(name) {
      const sound = sounds[name];
      if (sound) { sound.currentTime = 0; sound.volume = 0.35; sound.play().catch(()=>{}); }
    }

    // === Tema claro/escuro ===
    document.addEventListener("DOMContentLoaded",()=>{
      const themeButton=document.getElementById("themeToggle");
      const body=document.body;
      const saved=localStorage.getItem("theme");
      if(saved==="light"){body.classList.add("light-mode");themeButton.textContent="üåô Modo Escuro";}
      themeButton.addEventListener("click",()=>{
        body.classList.toggle("light-mode");
        const light=body.classList.contains("light-mode");
        themeButton.textContent=light?"üåô Modo Escuro":"‚òÄÔ∏è Modo Claro";
        localStorage.setItem("theme",light?"light":"dark");
        playSound("click");
      });
    });

    // === Splash ===
    document.addEventListener("DOMContentLoaded",()=>{
      const splash=document.getElementById("splash");
      setTimeout(()=>{ splash.style.opacity="0"; splash.style.visibility="hidden"; },1500);
    });

    // === Dados ===
    const eventos = JSON.parse(localStorage.getItem("eventos")) || [];
    const idSelecionado = Number(localStorage.getItem("eventoSelecionado"));
    const evento = eventos.find(e => e.id === idSelecionado);

    if(!evento){
      alert("Evento n√£o encontrado!");
      window.location.href = "index.html";
    }

    document.getElementById("tituloEvento").textContent = evento.nome;
    document.getElementById("dataEvento").textContent = "Data: " + (new Date(evento.data).toLocaleDateString("pt-BR"));

    const listaLotes = document.getElementById("listaLotes");
    const secaoSetores = document.getElementById("secaoSetores");
    const listaSetores = document.getElementById("listaSetores");

    function renderLotes(){
      listaLotes.innerHTML = "";
      if(!evento.lotes || !evento.lotes.length){
        listaLotes.innerHTML = "<p>Nenhum lote cadastrado.</p>";
        return;
      }
      evento.lotes.forEach((lote, i)=>{
        const div = document.createElement("div");
        div.classList.add("lote-card");
        div.innerHTML = `
          <h4>${lote.nome}</h4>
          <p>${lote.setores?.length || 0} setor(es)</p>
          <button onclick="abrirLote(${i})">Editar</button>
          <button onclick="excluirLote(${i})" class="btn-cancelar">Excluir</button>
        `;
        listaLotes.appendChild(div);
      });
    }

    function abrirLote(i){
      secaoSetores.style.display = "block";
      listaSetores.innerHTML = "";
      const lote = evento.lotes[i];
      document.getElementById("tituloLote").textContent = "Editando: " + lote.nome;
      listaSetores.dataset.index = i;
      (lote.setores || []).forEach((s, idx)=>{
        const div = document.createElement("div");
        div.classList.add("setor");
        div.innerHTML = `
          <input type="text" value="${s.setor}" placeholder="Nome do setor">
          <input type="number" value="${s.valores.meia}" placeholder="Meia">
          <input type="number" value="${s.valores.solidario}" placeholder="Solid√°rio">
          <input type="number" value="${s.valores.inteira}" placeholder="Inteira">
          <button onclick="removerSetor(${idx})" class="btn-cancelar">üóë</button>
        `;
        listaSetores.appendChild(div);
      });
    }

    function excluirLote(i){
      if(!confirm("Excluir este lote?")) return;
      evento.lotes.splice(i,1);
      salvar();
      renderLotes();
    }

    function salvar(){
      const eventos = JSON.parse(localStorage.getItem("eventos")) || [];
      const idx = eventos.findIndex(e => e.id === evento.id);
      eventos[idx] = evento;
      localStorage.setItem("eventos", JSON.stringify(eventos));
    }

    function adicionarSetor(){
      const i = Number(listaSetores.dataset.index);
      if(i >= 0){
        evento.lotes[i].setores = evento.lotes[i].setores || [];
        evento.lotes[i].setores.push({
          setor: "Novo Setor",
          valores: {meia:0, solidario:0, inteira:0}
        });
        salvar();
        abrirLote(i);
      }
    }

    function removerSetor(idx){
      const i = Number(listaSetores.dataset.index);
      evento.lotes[i].setores.splice(idx,1);
      salvar();
      abrirLote(i);
    }

    function salvarLote(){
      const i = Number(listaSetores.dataset.index);
      const inputs = listaSetores.querySelectorAll(".setor");
      const setores = [];
      inputs.forEach(div=>{
        const [setor, meia, solid, inte] = div.querySelectorAll("input");
        setores.push({
          setor: setor.value.trim() || "Setor",
          valores: {
            meia: Number(meia.value) || 0,
            solidario: Number(solid.value) || 0,
            inteira: Number(inte.value) || 0
          }
        });
      });
      evento.lotes[i].setores = setores;
      salvar();
      alert("‚úÖ Lote salvo com sucesso!");
      secaoSetores.style.display = "none";
      renderLotes();
    }

    document.getElementById("btnNovoLote").onclick = ()=>{
      const nome = prompt("Nome do novo lote:");
      if(!nome) return;
      evento.lotes = evento.lotes || [];
      evento.lotes.push({ nome, setores: [] });
      salvar();
      renderLotes();
    };

    document.getElementById("btnAddSetor").onclick = adicionarSetor;
    document.getElementById("btnSalvarLote").onclick = salvarLote;
    document.getElementById("btnFecharLote").onclick = ()=>{
      secaoSetores.style.display="none";
    };
    document.getElementById("voltar").onclick = ()=>{
      window.location.href = "index.html";
    };

    renderLotes();
  </script>
</body>
</html>
